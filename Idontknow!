local HttpService = game:GetService("HttpService")

local userKey = script_key  -- Get the key from the loader script
local webhookURL = ""
local realScriptURL = "https://raw.githubusercontent.com/Estplugs/test/refs/heads/main/lua"

local userHWID = "NO_HWID_FUNCTION"
if gethwid then
    userHWID = gethwid()
end

local executorName = "UnknownExecutor"
if identifyexecutor then
    executorName = identifyexecutor() or "UnknownExecutor"
end

local placeId = game.PlaceId
local jobId = game.JobId or "UnknownJobId"
local placeName = "UnknownPlace"
pcall(function()
    local info = game:GetService("MarketplaceService"):GetProductInfo(placeId)
    placeName = info.Name or "UnknownPlace"
end)

local validateUrl = string.format("http://127.0.0.1:5000/validate_key?key=%s&hwid=%s", userKey, userHWID)

local success, response = pcall(function()
    return http.request({
        Url = validateUrl,
        Method = "GET"
    })
end)

if not success or not response then
    game.Players.LocalPlayer:Kick("Whitelist check failed. No response from server.")
    return
end

if response.StatusCode ~= 200 then
    game.Players.LocalPlayer:Kick("Whitelist check failed: "..(response.Body or "Unknown error"))
    return
end

local data
local decodeOK, decodeErr = pcall(function()
    data = HttpService:JSONDecode(response.Body)
end)
if not decodeOK then
    game.Players.LocalPlayer:Kick("Whitelist check: invalid JSON => "..(decodeErr or "nil"))
    return
end

if not data.valid then
    game.Players.LocalPlayer:Kick("Whitelist check failed => "..(data.reason or "nil"))
    return
end

local discordId = data.discord_id or "Unknown"
local executionCount = data.execution_count or 0

local embedData = {
    title = "Whitelist Execution Log",
    description = "User executed the script.",
    color = 0x2ECC71,
    fields = {
        {
            name = "HWID",
            value = userHWID,
            inline = true
        },
        {
            name = "Executor",
            value = executorName,
            inline = true
        },
        {
            name = "Key",
            value = userKey,
            inline = false
        },
        {
            name = "Discord ID",
            value = discordId,
            inline = false
        },
        {
            name = "Execution Count",
            value = tostring(executionCount),
            inline = false
        },
        {
            name = "Job ID",
            value = jobId,
            inline = false
        },
        {
            name = "Place ID",
            value = tostring(placeId),
            inline = true
        },
        {
            name = "Game Name",
            value = placeName,
            inline = true
        }
    }
}

local webhookBody = {
    username = "Whitelist Logger",
    embeds = {embedData}
}

local encoded = HttpService:JSONEncode(webhookBody)
pcall(function()
    http.request({
        Url = webhookURL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = encoded
    })
end)

local success2, err2 = pcall(function()
    loadstring(game:HttpGet(realScriptURL))()
end)
if not success2 then
    game.Players.LocalPlayer:Kick("Failed to load main script => "..tostring(err2))
end
